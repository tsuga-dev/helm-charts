# yaml-language-server: $schema=../../values.schema.json
agent:
  image: ghcr.io/open-telemetry/opentelemetry-collector-releases/opentelemetry-collector-contrib
  addLogsVolumes: true
  collectLogs: false
  config:
    extraExtensions:
      k8s_observer:
        observe_nodes: true
        observe_services: true
        observe_ingresses: true
    extraReceivers:
      receiver_creator/logs:
        watch_observers: [k8s_observer]
        discovery:
          enabled: true
      receiver_creator/redis:
        watch_observers: [k8s_observer]
        receivers:
          redis:
            # Match valkey-cart pods - using name pattern matching
            rule: type == "pod" && name matches ".*valkey-cart.*"
            config:
              endpoint: "`endpoint`:6379"
              collection_interval: 10s
              username: valkey
      receiver_creator/nginx:
        watch_observers: [k8s_observer]
        receivers:
          nginx:
            # Match image-provider pods - using name pattern matching
            rule: type == "pod" && name matches ".*image-provider.*"
            config:
              endpoint: "http://`endpoint`:8081/status"
              collection_interval: 10s
      postgresql:
        endpoint: postgresql:5432
        metrics:
          postgresql.blks_hit:
            enabled: true
          postgresql.blks_read:
            enabled: true
          postgresql.deadlocks:
            enabled: true
          postgresql.tup_deleted:
            enabled: true
          postgresql.tup_fetched:
            enabled: true
          postgresql.tup_inserted:
            enabled: true
          postgresql.tup_returned:
            enabled: true
          postgresql.tup_updated:
            enabled: true
        password: otel
        tls:
          insecure: true
        username: root
    service:
      extraExtensions:
        - k8s_observer
      pipelines:
        metrics:
          extraReceivers:
            - postgresql
            - receiver_creator/redis
            - receiver_creator/nginx
        logs:
          extraReceivers:
            - receiver_creator/logs
