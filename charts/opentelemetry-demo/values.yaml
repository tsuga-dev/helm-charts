opentelemetry-demo:
  enabled: true

  default:
    envOverrides:
      - name: OTEL_COLLECTOR_NAME
        valueFrom:
          fieldRef:
            apiVersion: v1
            fieldPath: status.hostIP

  components:
    accounting:
      podAnnotations:
        resource.opentelemetry.io/team: services
    ad:
      podAnnotations:
        resource.opentelemetry.io/team: services
    cart:
      podAnnotations:
        resource.opentelemetry.io/team: app
    checkout:
      podAnnotations:
        resource.opentelemetry.io/team: app
    currency:
      podAnnotations:
        resource.opentelemetry.io/team: services
    email:
      podAnnotations:
        resource.opentelemetry.io/team: services
    fraud-detection:
      podAnnotations:
        resource.opentelemetry.io/team: services
    frontend:
      podAnnotations:
        resource.opentelemetry.io/team: app
        resource.opentelemetry.io/service.name: frontend
        io.opentelemetry.discovery.logs/enabled: "true"
        io.opentelemetry.discovery.logs/config: |
          include_file_path: true
          operators:
            - type: container
              id: container-parser

            # Recombine Next.js multi-line errors (stack traces)
            - type: recombine
              id: nextjs-multiline
              combine_field: body
              is_first_entry: body matches "^Error:"
              source_identifier: attributes["log.file.path"]
              force_flush_period: 2s
              max_log_size: 2MiB
              preserve_leading_whitespaces: true
    frontend-proxy:
      podAnnotations:
        resource.opentelemetry.io/team: platform
    image-provider:
      podAnnotations:
        resource.opentelemetry.io/team: platform
        resource.opentelemetry.io/service.name: image-provider
        io.opentelemetry.discovery.logs/enabled: "true"
        io.opentelemetry.discovery.logs/config: |
          include_file_path: true
          operators:
            - type: container
              id: container-parser

            # Recombine Envoy/nginx multi-line logs (continuation lines without timestamp)
            - type: recombine
              id: envoy-multiline
              combine_field: body
              is_first_entry: body matches "^\\[\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2}\\.\\d{3}\\]"
              source_identifier: attributes["log.file.path"]
              force_flush_period: 2s
              max_log_size: 2MiB
              preserve_leading_whitespaces: true
    load-generator:
      podAnnotations:
        resource.opentelemetry.io/team: platform
    payment:
      podAnnotations:
        resource.opentelemetry.io/team: services
    product-catalog:
      podAnnotations:
        resource.opentelemetry.io/team: services
    product-reviews:
      podAnnotations:
        resource.opentelemetry.io/team: services
      imageOverride:
        repository: "014498635196.dkr.ecr.eu-central-1.amazonaws.com/tsuga-dev/otel-demo"
        tag: "2.2.0-product-reviews"
    quote:
      podAnnotations:
        resource.opentelemetry.io/team: services
    recommendation:
      podAnnotations:
        resource.opentelemetry.io/team: services
    shipping:
      podAnnotations:
        resource.opentelemetry.io/team: services
    flagd:
      podAnnotations:
        resource.opentelemetry.io/team: platform
    kafka:
      podAnnotations:
        resource.opentelemetry.io/team: platform
    postgresql:
      command:
        - docker-entrypoint.sh
        - -c
        - log_destination=stderr
        - -c
        - log_min_duration_statement=0
        - -c
        - log_line_prefix=%m [%p] %u@%d %
      podAnnotations:
        resource.opentelemetry.io/team: platform
        resource.opentelemetry.io/service.name: postgresql
        io.opentelemetry.discovery.logs/enabled: "true"
        io.opentelemetry.discovery.logs/config: |
          include_file_path: true
          operators:
            - type: container
              id: container-parser

            # Drop Postgres DETAIL logs
            - type: filter
              id: drop-postgres-detail
              expr: 'body matches "^\\d{4}-\\d{2}-\\d{2} .*\\bDETAIL:"'

            # Recombine Postgres multi-line statements (SQL blocks, wrapped lines, etc.)
            - type: recombine
              id: postgres-multiline
              combine_field: body
              is_first_entry: body matches "^\\d{4}-\\d{2}-\\d{2} "
              source_identifier: attributes["log.file.path"]
              force_flush_period: 2s
              max_log_size: 2MiB
              preserve_leading_whitespaces: true
    valkey-cart:
      podAnnotations:
        resource.opentelemetry.io/team: platform
        resource.opentelemetry.io/service.name: valkey-cart
        io.opentelemetry.discovery.logs/enabled: "true"
        io.opentelemetry.discovery.logs/config: |
          include_file_path: true
          operators:
            - type: container
              id: container-parser

            # Recombine Valkey/Redis multi-line logs (entries start with process:role timestamp pattern)
            - type: recombine
              id: valkey-multiline
              combine_field: body
              is_first_entry: body matches "^\\d+:[A-Z] \\d{2} [A-Z][a-z]{2} \\d{4} \\d{2}:\\d{2}:\\d{2}\\.\\d{3}"
              source_identifier: attributes["log.file.path"]
              force_flush_period: 2s
              max_log_size: 2MiB
              preserve_leading_whitespaces: true

  opentelemetry-collector:
    enabled: false
  jaeger:
    enabled: false
  opensearch:
    enabled: false
  prometheus:
    enabled: false
  grafana:
    enabled: false

opentelemetry-kube-stack:
  enabled: true
  agent:
    image: ghcr.io/open-telemetry/opentelemetry-collector-releases/opentelemetry-collector-contrib
    addLogsVolumes: true
    collectLogs: false
    config:
      extraExtensions:
        k8s_observer:
          observe_nodes: true
          observe_services: true
          observe_ingresses: true
      extraReceivers:
        receiver_creator/logs:
          watch_observers: [k8s_observer]
          discovery:
            enabled: true
        receiver_creator/redis:
          watch_observers: [k8s_observer]
          receivers:
            redis:
              # Match valkey-cart pods - using name pattern matching
              rule: type == "pod" && name matches ".*valkey-cart.*"
              config:
                endpoint: "`endpoint`:6379"
                collection_interval: 10s
                username: valkey
        receiver_creator/nginx:
          watch_observers: [k8s_observer]
          receivers:
            nginx:
              # Match image-provider pods - using name pattern matching
              rule: type == "pod" && name matches ".*image-provider.*"
              config:
                endpoint: "http://`endpoint`:8081/status"
                collection_interval: 10s
        postgresql:
          endpoint: postgresql:5432
          metrics:
            postgresql.blks_hit:
              enabled: true
            postgresql.blks_read:
              enabled: true
            postgresql.deadlocks:
              enabled: true
            postgresql.tup_deleted:
              enabled: true
            postgresql.tup_fetched:
              enabled: true
            postgresql.tup_inserted:
              enabled: true
            postgresql.tup_returned:
              enabled: true
            postgresql.tup_updated:
              enabled: true
          password: otel
          tls:
            insecure: true
          username: root
      extraExporters:
        debug:
          verbosity: detailed
      service:
        extraExtensions:
          - k8s_observer
        pipelines:
          metrics:
            extraReceivers:
              - postgresql
              - receiver_creator/redis
              - receiver_creator/nginx
            extraExporters:
              - debug
          logs:
            extraReceivers:
              - receiver_creator/logs

# Optional subchart: vanilla spicy-gremlin for synthetic failures in the OTel demo.
# Set enabled=true to run with image defaults (randomized scenarios and built-in OFF baseline).
tsuga-spicy-gremlin:
  enabled: true
  env:
    minIntervalSec: 120
    maxIntervalSec: 600
  image:
    tag: "0.1.3"
  extraEnv:
    - name: OTEL_EXPORTER_OTLP_PROTOCOL
      value: http/protobuf
    - name: OTEL_COLLECTOR_NAME
      valueFrom:
        fieldRef:
          apiVersion: v1
          fieldPath: status.hostIP
    - name: OTEL_TRACES_EXPORTER
      value: otlp
    - name: OTEL_METRICS_EXPORTER
      value: otlp
    - name: OTEL_LOGS_EXPORTER
      value: none
    - name: OTEL_SERVICE_NAME
      value: spicy-gremlin
    - name: OTEL_SERVICE_VERSION
      value: "0.1.3"
    - name: POD_NAMESPACE
      valueFrom:
        fieldRef:
          apiVersion: v1
          fieldPath: metadata.namespace
    - name: OTEL_RESOURCE_ATTRIBUTES
      value: service.name=$(OTEL_SERVICE_NAME),service.version=$(OTEL_SERVICE_VERSION),service.namespace=$(POD_NAMESPACE)
    - name: OTEL_TRACES_SAMPLER
      value: parentbased_traceidratio
    - name: OTEL_TRACES_SAMPLER_ARG
      value: "1.0"
    - name: OTEL_METRIC_EXPORT_INTERVAL
      value: "60000"
  podAnnotations:
    resource.opentelemetry.io/team: platform
    resource.opentelemetry.io/service.name: spicy-gremlin
    resource.opentelemetry.io/service.version: "0.1.3"
    io.opentelemetry.discovery.logs/enabled: "true"
    io.opentelemetry.discovery.logs/config: |
      include_file_path: true
      operators:
        - type: container
          id: container-parser
