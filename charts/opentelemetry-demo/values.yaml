opentelemetry-demo:
  enabled: true


  default:
    envOverrides:
      - name: OTEL_COLLECTOR_NAME
        valueFrom:
          fieldRef:
            apiVersion: v1
            fieldPath: status.hostIP

  components:
    accounting:
      podAnnotations:
        resource.opentelemetry.io/team: services
      env:
        # .NET auto-instrumentation: enable additional metric sources
        - name: OTEL_DOTNET_AUTO_METRICS_ADDITIONAL_SOURCES
          value: "System.Runtime,Microsoft.AspNetCore.Hosting"
    ad:
      podAnnotations:
        resource.opentelemetry.io/team: services
      env:
        # Enable JVM metrics (heap, GC, threads, classes)
        - name: OTEL_INSTRUMENTATION_RUNTIME_TELEMETRY_ENABLED
          value: "true"
        - name: OTEL_INSTRUMENTATION_RUNTIME_TELEMETRY_EMIT_EXPERIMENTAL_TELEMETRY
          value: "true"
        # Enable JMX metrics
        - name: OTEL_INSTRUMENTATION_JMX_ENABLED
          value: "true"
        # Enable detailed HTTP metrics
        - name: OTEL_INSTRUMENTATION_HTTP_CAPTURE_HEADERS_CLIENT_REQUEST
          value: "content-type,user-agent"
        - name: OTEL_INSTRUMENTATION_HTTP_CAPTURE_HEADERS_SERVER_REQUEST
          value: "content-type,user-agent,accept"
        # Enable gRPC detailed metrics
        - name: OTEL_INSTRUMENTATION_GRPC_ENABLED
          value: "true"
        # Enable Log4j appender for application logs
        - name: OTEL_INSTRUMENTATION_LOG4J_APPENDER_ENABLED
          value: "true"
    cart:
      podAnnotations:
        resource.opentelemetry.io/team: app
    checkout:
      podAnnotations:
        resource.opentelemetry.io/team: app
    currency:
      podAnnotations:
        resource.opentelemetry.io/team: services
    email:
      podAnnotations:
        resource.opentelemetry.io/team: services
    fraud-detection:
      podAnnotations:
        resource.opentelemetry.io/team: services
      env:
        # Enable JVM runtime metrics (heap, GC, threads, classes)
        - name: OTEL_INSTRUMENTATION_RUNTIME_TELEMETRY_ENABLED
          value: "true"
        - name: OTEL_INSTRUMENTATION_RUNTIME_TELEMETRY_EMIT_EXPERIMENTAL_TELEMETRY
          value: "true"
        # Enable JMX metrics
        - name: OTEL_INSTRUMENTATION_JMX_ENABLED
          value: "true"
        # Enable Kafka consumer/producer instrumentation
        - name: OTEL_INSTRUMENTATION_KAFKA_ENABLED
          value: "true"
        - name: OTEL_INSTRUMENTATION_KAFKA_METRIC_REPORTER_ENABLED
          value: "true"
        # Enable Log4j appender (fraud-detection uses Log4j, not Logback)
        - name: OTEL_INSTRUMENTATION_LOG4J_APPENDER_ENABLED
          value: "true"
    frontend:
      podAnnotations:
        resource.opentelemetry.io/team: app
    frontend-proxy:
      podAnnotations:
        resource.opentelemetry.io/team: platform
    image-provider:
      podAnnotations:
        resource.opentelemetry.io/team: platform
    load-generator:
      podAnnotations:
        resource.opentelemetry.io/team: platform
    payment:
      podAnnotations:
        resource.opentelemetry.io/team: services
    product-catalog:
      podAnnotations:
        resource.opentelemetry.io/team: services
    product-reviews:
      podAnnotations:
        resource.opentelemetry.io/team: services
      imageOverride:
        repository: "014498635196.dkr.ecr.eu-central-1.amazonaws.com/tsuga-dev/otel-demo"
        tag: "2.2.0-product-reviews"
    quote:
      podAnnotations:
        resource.opentelemetry.io/team: services
    recommendation:
      podAnnotations:
        resource.opentelemetry.io/team: services
      env:
        # Enable Python runtime metrics (GC, threads, memory)
        - name: OTEL_PYTHON_LOGGING_AUTO_INSTRUMENTATION_ENABLED
          value: "true"
    shipping:
      podAnnotations:
        resource.opentelemetry.io/team: services
    flagd:
      podAnnotations:
        resource.opentelemetry.io/team: platform
    kafka:
      podAnnotations:
        resource.opentelemetry.io/team: platform
    postgresql:
      command: 
       - docker-entrypoint.sh
       - -c
       - log_destination=stderr
       - -c
       - log_min_duration_statement=0
       - -c
       - log_line_prefix=%m [%p] %u@%d %
      podAnnotations:
        resource.opentelemetry.io/team: platform
        resource.opentelemetry.io/service.name: postgresql
        io.opentelemetry.discovery.logs/enabled: "true"
        io.opentelemetry.discovery.logs/config: |
          include_file_path: true
          operators:
            - type: container
              id: container-parser

            # Drop Postgres DETAIL logs
            - type: filter
              id: drop-postgres-detail
              expr: 'body matches "^\\d{4}-\\d{2}-\\d{2} .*\\bDETAIL:"'

            # Recombine Postgres multi-line statements (SQL blocks, wrapped lines, etc.)
            - type: recombine
              id: postgres-multiline
              combine_field: body
              is_first_entry: body matches "^\\d{4}-\\d{2}-\\d{2} "
              source_identifier: attributes["log.file.path"]
              force_flush_period: 2s
              max_log_size: 2MiB
              preserve_leading_whitespaces: true
    valkey-cart:
      podAnnotations:
        resource.opentelemetry.io/team: platform
    

  opentelemetry-collector:
    enabled: false
  jaeger:
    enabled: false
  opensearch:
    enabled: false
  prometheus:
    enabled: false
  grafana:
    enabled: false

opentelemetry-kube-stack:
  enabled: true
  agent:
    image: ghcr.io/open-telemetry/opentelemetry-collector-releases/opentelemetry-collector-contrib
    addLogsVolumes: true
    collectLogs: false
    config:
      extraExtensions:
        k8s_observer:
          observe_nodes: true
          observe_services: true
          observe_ingresses: true  
      extraReceivers:
        receiver_creator/logs:
          watch_observers: [ k8s_observer ]
          discovery:
            enabled: true
        # Nginx/Image Provider metrics
        nginx:
          endpoint: http://image-provider.default:8081/status
          collection_interval: 10s
        # Kafka metrics
        kafkametrics:
          brokers:
            - kafka:9092
          protocol_version: "2.0.0"
          scrapers:
            - brokers
            - topics
            - consumers
          collection_interval: 10s
          topic_match: "^[^_].*$"  # Exclude internal topics (starting with _)
          group_match: ".*"         # Include all consumer groups
          metrics:
            # Enable additional partition-level metrics
            kafka.partition.current_offset:
              enabled: true
            kafka.partition.oldest_offset:
              enabled: true
            kafka.partition.replicas:
              enabled: true
            kafka.partition.replicas_in_sync:
              enabled: true
            # Enable consumer lag metrics
            kafka.consumer_group.lag:
              enabled: true
            kafka.consumer_group.offset:
              enabled: true
        # PostgreSQL metrics
        postgresql:
          endpoint: postgresql.default:5432
          username: root
          password: otel
          collection_interval: 10s
          tls:
            insecure: true
          metrics:
            # Block I/O metrics
            postgresql.blks_hit:
              enabled: true
            postgresql.blks_read:
              enabled: true
            # Transaction metrics
            postgresql.commits:
              enabled: true
            postgresql.rollbacks:
              enabled: true
            # Concurrency metrics
            postgresql.backends:
              enabled: true
            postgresql.deadlocks:
              enabled: true
            postgresql.database.locks:
              enabled: true
            # Tuple operation metrics
            postgresql.tup_deleted:
              enabled: true
            postgresql.tup_fetched:
              enabled: true
            postgresql.tup_inserted:
              enabled: true
            postgresql.tup_returned:
              enabled: true
            postgresql.tup_updated:
              enabled: true
            # Performance indicators
            postgresql.sequential_scans:
              enabled: true
            postgresql.temp_files:
              enabled: true
            # Connection pool metrics
            postgresql.connection.max:
              enabled: true
            # Table-level metrics
            postgresql.table.count:
              enabled: true
            postgresql.table.size:
              enabled: true
            postgresql.table.vacuum.count:
              enabled: true
            # Index metrics
            postgresql.index.scans:
              enabled: true
            postgresql.index.size:
              enabled: true
            # Replication metrics
            postgresql.replication.data_delay:
              enabled: true
        # Redis/Valkey metrics
        redis:
          endpoint: valkey-cart.default:6379
          username: valkey
          collection_interval: 10s
          metrics:
            # Command-level metrics
            redis.cmd.calls:
              enabled: true
            redis.cmd.latency:
              enabled: true
            # Memory metrics
            redis.maxmemory:
              enabled: true
            redis.memory.used:
              enabled: true
            redis.memory.peak:
              enabled: true
            redis.memory.rss:
              enabled: true
            redis.memory.lua:
              enabled: true
            # Connection metrics
            redis.clients.connected:
              enabled: true
            redis.clients.blocked:
              enabled: true
            # Key metrics
            redis.keys.evicted:
              enabled: true
            redis.keys.expired:
              enabled: true
            # Network metrics
            redis.net.input:
              enabled: true
            redis.net.output:
              enabled: true
            # Replication metrics
            redis.replication.offset:
              enabled: true
            # CPU metrics
            redis.cpu.time:
              enabled: true
        # Prometheus scraper for Envoy stats
        prometheus:
          config:
            scrape_configs:
              - job_name: envoy
                scrape_interval: 30s
                metrics_path: /stats/prometheus
                static_configs:
                  - targets:
                      - frontend-proxy:10000
      service:
        extraExtensions:
          - k8s_observer
        pipelines:
          metrics:
            extraReceivers:
              - postgresql
              - redis
              - nginx
              - kafkametrics
              - prometheus
          logs:
            extraReceivers:
              - receiver_creator/logs
